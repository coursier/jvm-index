name: Update index
on:
  push:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: coursier/cache-action@v8.0
      - uses: coursier/setup-action@v2.0
        with:
          jvm: 21

      # That's for the "Post index summary comment" step below
      # Claude Sonnet 4.6 generated
      - name: Snapshot base indices
        if: github.ref == 'refs/heads/master'
        run: cp -r indices/ /tmp/base-indices

      - run: ./scala-cli.sh src
        env:
          GH_TOKEN: ${{ secrets.INDEX_GITHUB_TOKEN }}

      - name: Print diff
        run: git diff --color --diff-algorithm=patience

      - name: Create Pull Request
        if: github.ref == 'refs/heads/master'
        id: cpr
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          commit-message: Update index
          author: GitHub <noreply@github.com>
          delete-branch: true
          title: Update index

      # Claude Sonnet 4.6 generated
      - name: Post index summary comment
        if: github.ref == 'refs/heads/master' && steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.INDEX_GITHUB_TOKEN }}
        run: |
          SUMMARY=$(./scala-cli.sh .github/scripts/summarize-index-changes.scala -- /tmp/base-indices indices/)
          MARKER="<!-- pr-index-summary -->"
          BODY="${MARKER}
          ## Index Changes Summary

          ${SUMMARY}"
          PR_NUMBER="${{ steps.cpr.outputs.pull-request-number }}"
          EXISTING_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq ".[] | select(.body | startswith(\"${MARKER}\")) | .id")
          if [ -n "$EXISTING_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING_ID}" \
              -X PATCH -f body="$BODY"
          else
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              -X POST -f body="$BODY"
          fi

      - name: Generate Job Summary
        if: github.ref == 'refs/heads/master'
        run: |-
          PR_NUMBER=$(echo "${{ steps.cpr.outputs.pull-request-number }}")
          PR_URL=$(echo "${{ steps.cpr.outputs.pull-request-url }}")
          echo "## Index Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull Request Number - **${PR_NUMBER}**" >> $GITHUB_STEP_SUMMARY
          echo "Pull Request URL - **${PR_URL}**" >> $GITHUB_STEP_SUMMARY
